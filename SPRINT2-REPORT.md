# –°–ü–†–ò–ù–¢ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ WinAPI

## üéØ –¶–µ–ª–∏ –°–ø—Ä–∏–Ω—Ç–∞ 2
- **–ó–∞–¥–∞—á–∞ ‚Ññ1**: –£–±—Ä–∞—Ç—å "—à—É–º–Ω—ã–µ" PowerShell –≤—ã–∑–æ–≤—ã
- **–ó–∞–¥–∞—á–∞ ‚Ññ2**: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è WinAPI –º–∏–≥—Ä–∞—Ü–∏–∏  
- **–ó–∞–¥–∞—á–∞ ‚Ññ3**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Windows API
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã Windows API dependencies –≤ Cargo.toml
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã features –¥–ª—è WinAPI –º–æ–¥—É–ª–µ–π:
  - `Win32_System_Services` (–¥–ª—è —Å–ª—É–∂–±)
  - `Win32_System_Registry` (–¥–ª—è —Ä–µ–µ—Å—Ç—Ä–∞) 
  - `Win32_System_Diagnostics_ToolHelp` (–¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
  - `Win32_Security_Cryptography` (–¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π)

### 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã

#### Services (services.rs) 
**–°—Ç–∞—Ç—É—Å:** üü° –£–ª—É—á—à–µ–Ω–Ω—ã–π PowerShell ‚Üí üéØ –°–ª–µ–¥—É—é—â–∏–π: –ø–æ–ª–Ω–∞—è WinAPI –º–∏–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ PowerShell –∑–∞–ø—Ä–æ—Å—ã (-NoProfile, -NoLogo)
- ‚úÖ –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ OpenSCManagerW + EnumServicesStatusExW
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞**: –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤ –≤ windows-rs crate (SC_HANDLE, Result<>)

#### Registry (registry.rs)
**–°—Ç–∞—Ç—É—Å:** üü° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PowerShell ‚Üí üéØ –°–ª–µ–¥—É—é—â–∏–π: RegOpenKeyExW
- ‚úÖ –ï–¥–∏–Ω—ã–µ PowerShell –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π Run
- ‚úÖ –ë–µ—Å—à—É–º–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (SilentlyContinue)
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–∞–∂–Ω—ã—Ö LSA/IFEO/AppInit –∑–Ω–∞—á–µ–Ω–∏–π
- ‚ö†Ô∏è **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**: WinAPI —Ç–∏–ø—ã (HKEY, PWSTR, REG_VALUE_TYPE)

#### –ü—Ä–æ—Ü–µ—Å—Å—ã –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã
- üìã **–ü–ª–∞–Ω**: –°–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç - CreateToolhelp32Snapshot –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- üìã **–ü–ª–∞–Ω**: COM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è Task Scheduler
- üìã **–ü–ª–∞–Ω**: WMI API –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚è±Ô∏è **–í—Ä–µ–º—è —Å–±–æ—Ä–∞**: 11.30s (–±—ã–ª–æ ~10s, –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ)
- üìä **–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö**: ~160KB JSON
- üîç **–î–µ—Ç–µ–∫—Ü–∏—è**: –°—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç 3 —É–≥—Ä–æ–∑—ã

#### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- ‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è 9 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–≤ –æ—Å–Ω–æ–≤–Ω–æ–º unused variables –≤ PowerShell —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö)
- ‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

## üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
```powershell
# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
.\target\release\forensic-agent.exe --fast --no-events --no-certs -o sprint2-test

# –†–µ–∑—É–ª—å—Ç–∞—Ç: 3 –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã
# - –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª—É–∂–±–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–µ
# - –ù–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è —Å–ª—É–∂–±–∞ –≤–Ω–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞  
# - LOLBAS PowerShell –ø—Ä–æ—Ü–µ—Å—Å
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –°–ø—Ä–∏–Ω—Ç 1 | –°–ø—Ä–∏–Ω—Ç 2 | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|----------|----------|-----------|
| –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ | 47s | 34s | üü¢ -27% |
| –†–∞–∑–º–µ—Ä exe | 1.7MB | 1.7MB | ‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–æ |
| –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è | 22 | 9 | üü¢ -59% |
| –î–µ—Ç–µ–∫—Ü–∏—è —É–≥—Ä–æ–∑ | 2 | 3 | üü¢ +50% |
| PowerShell –≤—ã–∑–æ–≤—ã | –®—É–º–Ω—ã–µ | –¢–∏—Ö–∏–µ | üü¢ –£–ª—É—á—à–µ–Ω–æ |

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–°–ø—Ä–∏–Ω—Ç 3)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ WinAPI
1. **Services.rs** - —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∞–º–∏ windows-rs
2. **Registry.rs** - –∑–∞–≤–µ—Ä—à–∏—Ç—å RegOpenKeyExW —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é  
3. **Processes.rs** - CreateToolhelp32Snapshot –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ù–æ–≤—ã–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã
1. **WMI subscriptions** - —á–µ—Ä–µ–∑ WMI API
2. **Task Scheduler** - —á–µ—Ä–µ–∑ COM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
3. **Digital signatures** - WinVerifyTrust –¥–ª—è —Ñ–∞–π–ª–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
1. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è** —Å–±–æ—Ä–∞ —á–µ—Ä–µ–∑ rayon
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **Streaming output** –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

## üí° –£—Ä–æ–∫–∏ –°–ø—Ä–∏–Ω—Ç–∞ 2

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –î–µ—Ç–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ PowerShell –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–ª–∞ –∑–∞–º–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏  
- ‚ö†Ô∏è Windows API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ª–æ–∂–Ω–µ–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ
- ‚ö†Ô∏è –¢–∏–ø—ã windows-rs crate —Ç—Ä–µ–±—É—é—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ –ª—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ WinAPI

### –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è
- üéØ **–ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è**: PowerShell ‚Üí WinAPI –ø–æ –æ–¥–Ω–æ–º—É –º–æ–¥—É–ª—é
- üéØ **–§–æ–∫—É—Å –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ**: –ª—É—á—à–µ –º–µ–Ω—å—à–µ, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ
- üéØ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ**: –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

## üèÜ –ò—Ç–æ–≥ –°–ø—Ä–∏–Ω—Ç–∞ 2
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** 60% (–±—ã–ª 40%)  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –°–ø—Ä–∏–Ω—Ç 3 - "–ù–∞—Ç–∏–≤–Ω—ã–µ WinAPI –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã"

–ü—Ä–æ–µ–∫—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è –æ—Ç –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º—É —Ñ–æ—Ä–µ–Ω–∑–∏–∫-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É! üöÄ
